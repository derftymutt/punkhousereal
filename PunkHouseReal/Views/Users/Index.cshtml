@model PunkHouseReal.Models.ItemViewModel<PunkHouseReal.Domain.HouseMate>;

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div ng-controller="meController as me">

    <h1>Hello {{me.user.firstName}} {{me.user.lastName}} of {{me.house.name}}</h1>

    <h3>My Housemates are:</h3>
    <div ng-repeat="hm in me.houseMates">
        <p>{{hm.firstName}} {{hm.lastName}}</p>
    </div>
    <hr />

    <h4>House Expenses</h4>
    <div ng-repeat="expense in me.houseExpenses">
        <p> {{$index + 1}}. <b>{{expense.houseMate.firstName}}</b> added: {{expense.name}}: {{expense.description}}. Added: {{expense.dateCreated | date}}</p>
        <p>Total: {{expense.total | currency}}, Due: {{expense.dueDate | date}}. Has everyone paid? - {{expense.isPaid}} </p>

    </div>
    <hr />
    <h4>My Expenses</h4>
    <div>
        <button class="btn btn-success" ng-click="me.onMyExpensesClick()">See my Expenses</button>
        <div>
            <ol>
                <li ng-repeat="expense in me.myExpenses">
                {{expense.name}}: {{expense.total | currency}}, Due: {{expense.dueDate | date}} <span ng-show="expense.isMarkedPaid">--- <i>marked paid... awaiting received payment confirmation</i> :)</span>
                    <div ng-show="!expense.isMarkedPaid">
                        <button class="btn btn-warning" ng-click="me.onMarkPaidClick(expense)">mark paid?</button>
                    </div>
                </li>
            </ol>
        </div>
    </div>

    <form name="house.createHouse" ng-submit="me.onCreateExpense()" novalidate>
        <div class="form-group">
            <label for="">Expense name:</label>
            <input type="text" class="form-control" id="expenseName" ng-maxlength="30" ng-model="me.expenseData.name" required>
        </div>
        <div class="form-group">
            <label for="">Type:</label>
            <select ng-model="me.expenseData.expenseType" ng-options="type for type in me.expenseTypes" required></select>
        </div>
        <div class="form-group">
            <label for="">Description:</label>
            <input type="text" class="form-control" id="expenseDescription" ng-maxlength="50" ng-model="me.expenseData.description">
        </div>
        <div class="form-group">
            <label for="">Total:</label>
            <input type="text" class="form-control" id="expenseTotal" ng-model="me.expenseData.total" required>
        </div>
        <div class="form-group">
            <input type="checkbox" id="expenseDivideCheckbox" ng-model="me.expenseData.isDividedUnevenly">
            <label for="">Divide payment unevenly amongst housemates?</label>
        </div>
        <div ng-show="me.expenseData.isDividedUnevenly">
            <h6>Leave blank for housemates that don't owe anything</h6>
            <div class="form-group" ng-repeat="hm in me.houseMates">
                <label for="">{{hm.firstName}} owes:</label>
                <input type="text" class="form-control" ng-model="me.unevenTotals[hm.id]">
            </div>
        </div>

        <div class="form-group">
            <label for="">Due Date:</label>
            <input type="date" class="form-control" id="expenseDueDate" ng-model="me.expenseData.dueDate">
        </div>

        <button type="submit" class="btn btn-success">{{me.submitExpense}}</button>
    </form>

</div>

@section Scripts { 

<script src="~/js/houseService.js"></script>
<script src="~/js/houseMateService.js"></script>
<script src="~/js/expenseService.js"></script>

<script>
    (function () {
        "use strict";

        angular.module("app").controller("meController", MeController);
        //inject
        MeController.$inject = ["houseService", "houseMateService", "expenseService"];

        function MeController(houseService, houseMateService, expenseService) {

            var vm = this;
            vm.houseService = houseService;
            vm.houseMateService = houseMateService;
            vm.expenseService = expenseService;

            vm.user = @Json.Serialize(Model.Item);
            vm.expenseTypes = ["Rent", "Bill", "Supply", "Other"];
            vm.submitExpense = "Submit";
            vm.isDividedUnevenly = false;
            vm.unevenTotals = {};

            vm.onCreateExpense = _onCreateExpense;
            vm.onMyExpensesClick = _onMyExpensesClick;
            vm.onMarkPaidClick = _onMarkPaidClick;


            render();
            function render() {
                //console.log(vm.user);

                //this is ok but might be redundant with houseService.getExpenses..
                // vm.houseService.get(vm.user.houseId).then(onGetHouseByIdSuccess, _onGetHouseByIdError);

                //BAD, REWORK
                vm.expenseService.getByHouseId(vm.user.houseId).then(_onGetExpenseByHouseIdSuccess, _onGetExpenseByHouseIdError);
                
                vm.houseService.getExpenses(vm.user.houseId).then(_onGetHouseExpensesSuccess, _onGetHouseExpensesError);
                
            }

            // -------------------- form submits ----------------------
            function _onCreateExpense() {
                console.log(vm.unevenTotals);
                if (!isCorrectSum(vm.expenseData.total, vm.unevenTotals)) 
                    return;
                //build data object
                vm.expenseData.creatorId = vm.user.id;
                vm.expenseData.houseId = vm.user.houseId;
                vm.expenseData.unevenTotals = vm.unevenTotals;

                vm.expenseService.create(vm.expenseData).then(_onCreateExpenseSuccess, _onCreateExpenseError);
            }

            //--------------- click handlers ---------------------
            function _onMyExpensesClick() {
                vm.myExpenses = [];
                for (var i = 0; i < vm.houseExpenses.length; i++) {
                    var expense = vm.houseExpenses[i];
                    for (var y = 0; y < expense.houseMateExpenses.length; y++) {
                        var houseMateExpense = expense.houseMateExpenses[y];
                        if (houseMateExpense.houseMateId == vm.user.id) {
                            houseMateExpense.creatorId = expense.creatorId;
                            houseMateExpense.name = expense.name;
                            houseMateExpense.dueDate = expense.dueDate;
                            houseMateExpense.expenseType = expense.expenseType;
                            vm.myExpenses.push(houseMateExpense);
                        }
                    }
                }

                console.log(vm.myExpenses);
            }

            function _onMarkPaidClick(expense) {

                console.log(expense);
                //return;

                if (!expense.isMarkedPaid) {
                    expense.isMarkedPaid = true;
                    //BAD, REWORK
                    vm.expenseService.updateHouseMateExpense(expense.expenseId, expense).then(_onUpdateHouseMateExpenseSuccess, _onUpdateHouseMateExpenseError);
                }

            }

            // ------------ helper functions ----------------
            function isCorrectSum(total, individualTotalsObj) {
                var sum = 0;
                for (var key in individualTotalsObj) {
                    var value = individualTotalsObj[key]; 
                    var valueAsInt = parseInt(value)
                    sum += valueAsInt;
                }
                return total == sum;
            }

            //------------------ Ajax responses ----------------------

            //might be redundant... test
            function onGetHouseByIdSuccess(data) {
                console.log("Get House by Id house success below");
                console.log(data);
                vm.house = data.data;
                vm.houseMates = data.data.houseMates;
            }

            function _onGetHouseByIdError() {
                console.log("error getting house");
            }

            function _onCreateExpenseSuccess(response) {
                console.log("Success adding expense!");
                console.log(response);
            }

            function _onCreateExpenseError() {
                console.log("Error creating expense");

            }

            //BAD, REWORK
            function _onGetExpenseByHouseIdSuccess(response) {
                console.log("original: get expense by houseId");
                console.log(response);
                vm.houseExpenses = response.data;

            }
            //BAD, REWORK
            function _onGetExpenseByHouseIdError() {
                console.log("error getting expense by houseId");

            }
            //BAD, REWORK
            function _onUpdateHouseMateExpenseSuccess(response) {
                console.log(response);
            }
            //BAD, REWORK
            function _onUpdateHouseMateExpenseError() {
                console.log("Error updating HouseMateExpense");
            }

            function _onGetHouseExpensesSuccess(response) {
                // console.log("Get House Expenses Success response below");
                console.log("my houses' expenses");
                console.log(response);
                vm.house = response.data;
                //vm.houseExpenses = response.data.expenses;
                vm.houseMates = response.data.houseMates;
                // console.log("vm.houseExpenses below");
                // console.log(vm.houseExpenses);

            }

            function _onGetHouseExpensesError() {
                console.log("error");
            }
        }

     }());
</script>
}
